groups:
  - name: crypto_bot_alerts
    rules:
      # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã
      - alert: HighErrorRate
        expr: sum(rate(bot_errors_total[1m])) by (error_type, shard) > 0.2
        for: 15s
        labels:
          severity: critical
        annotations:
          summary: "üî¥ –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–æ–∫"
          description: "–°–∫–æ—Ä–æ—Å—Ç—å –æ—à–∏–±–æ–∫: {{ $value | humanize }} –≤ —Å–µ–∫—É–Ω–¥—É"

      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "üî¥ –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          description: "–°–µ—Ä–≤–∏—Å {{ $labels.job }} –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

      # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      - alert: HighLatency
        expr: histogram_quantile(0.95, sum by (operation, le) (rate(bot_request_duration_seconds_bucket[5m]))) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤"
          description: "95-–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å –∑–∞–¥–µ—Ä–∂–∫–∏: {{ $value | humanize }}s"

      - alert: HighMemoryUsage
        expr: (bot_memory_usage_bytes / 1024 / 1024) > 900
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "‚ö†Ô∏è –í—ã—Å–æ–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏"
          description: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: {{ $value | humanize }}MB"

      - alert: HighCPUUsage
        expr: bot_cpu_usage_percent{shard="main"} > 50
        for: 10s
        labels:
          severity: warning
        annotations:
          summary: "‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU"
          description: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU: {{ $value }}%"

      # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
      - alert: DatabaseConnectionsHigh
        expr: bot_db_connections > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "‚ö†Ô∏è –ú–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ –ë–î"
          description: "–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π: {{ $value }}"

      - alert: SlowDatabaseQueries
        expr: histogram_quantile(0.95, rate(bot_db_query_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "‚ö†Ô∏è –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î"
          description: "95-–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—Ä–æ—Å–∞: {{ $value | humanize }}s"

      # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      - alert: UserDropOff
        expr: (delta(bot_active_users[24h]) / bot_active_users offset 24h) < -0.1
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "üìâ –ü–∞–¥–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
          description: "–°–Ω–∏–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 10% –∑–∞ 24 —á–∞—Å–∞"

      - alert: HighPremiumChurn
        expr: (delta(bot_premium_users[24h]) / bot_premium_users offset 24h) < -0.05
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "üíé –û—Ç—Ç–æ–∫ –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
          description: "–°–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 5% –∑–∞ 24 —á–∞—Å–∞"

      # Redis
      - alert: RedisErrors
        expr: increase(bot_errors_total{error_type=~"redis.*"}[5m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "üìõ –û—à–∏–±–∫–∏ Redis"
          description: "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Redis"

      # –û—á–µ—Ä–µ–¥–∏ NATS
      - alert: HighQueueLag
        expr: bot_queue_lag_seconds > 60
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ –æ—á–µ—Ä–µ–¥–∏"
          description: "–ó–∞–¥–µ—Ä–∂–∫–∞ –≤ –æ—á–µ—Ä–µ–¥–∏ {{ $labels.queue_name }}: {{ $value | humanize }}s"

      - alert: LargeQueueSize
        expr: bot_queue_size > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "‚ö†Ô∏è –ë–æ–ª—å—à–∞—è –æ—á–µ—Ä–µ–¥—å"
          description: "–†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ {{ $labels.queue_name }}: {{ $value }} —Å–æ–æ–±—â–µ–Ω–∏–π"

      # –ë—ç–∫–∞–ø—ã
      - alert: BackupFailure
        expr: bot_backup_status{type="daily"} == 0
        for: 1h
        labels:
          severity: critical
        annotations:
          summary: "üì• –û—à–∏–±–∫–∞ –±—ç–∫–∞–ø–∞"
          description: "–ü–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"

      - alert: SlowBackup
        expr: histogram_quantile(0.95, rate(bot_backup_duration_seconds_bucket[1h])) > 300
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "‚è±Ô∏è –ú–µ–¥–ª–µ–Ω–Ω—ã–π –±—ç–∫–∞–ø"
          description: "95-–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å –≤—Ä–µ–º–µ–Ω–∏ –±—ç–∫–∞–ø–∞: {{ $value | humanize }}s"

      # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞
      - alert: DiskSpaceCritical
        expr: (bot_disk_usage_bytes{type="free"} / bot_disk_usage_bytes{type="total"}) * 100 < 10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "üíæ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º–∞–ª–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ"
          description: "–û—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ 10% —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ {{ $labels.path }}"

      - alert: DiskSpaceWarning
        expr: (bot_disk_usage_bytes{type="free"} / bot_disk_usage_bytes{type="total"}) * 100 < 20
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "‚ö†Ô∏è –ú–∞–ª–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ"
          description: "–û—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ 20% —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ {{ $labels.path }}"

      # API
      - alert: ExternalAPIErrors
        expr: increase(bot_api_errors_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "üåê –û—à–∏–±–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ API"
          description: "{{ $value }} –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ API {{ $labels.api_name }}"
